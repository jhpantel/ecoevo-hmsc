---
title: "Detection of eco-evolutionary dynamics in metacommunities using Joint Species Distribution Models"
author: "Jelena H. Pantel, Ruben Hermann"
date: Ecological Modelling, Faculty of Biology, University of Duisburg-Essen, Universitätsstraße 5, 45141 Essen, Germany
output:
  pdf_document: default
  bookdown::pdf_document2: default
  html_document: default
  word_document:
    reference_docx: docx_template.docx
header-includes:
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyhead[L]{Pantel, JH}
- \fancyhead[R]{Detection of ecoevo dynamics}
- \usepackage{lineno}
- \linenumbers
linestretch: 2
link-citations: yes
linkcolor: blue
csl: evolution.csl
bibliography: refs.bib
---

```{r setup,echo=FALSE,warning=FALSE,message=FALSE}
library(bookdown)
library(R.matlab)
library(Hmsc)
library(vegan)
library(qgraph)
library(SNFtool)

library(ecoevor)
library(here)

library(grDevices)
library(knitr)

library(beanplot)
library(dplyr)
library(gplots)
library(formatR)
library(rmarkdown)
library(rsvg)
```
```{r echo=FALSE,eval=TRUE}
CV <- function(x){
  a <- mean(x,na.rm=T)	#Get the average of all values
  b <- (x - a)^2					#Squared deviations from mean
  c <- sqrt((sum(b,na.rm=T))/(length(x[is.na(x) == F])-1)) #sum squared deviations, divide by sample N-1, take square root
  d <- c/a  #coefficient of variation
  return(CV=d)
}

standard_error <- function(x){
	st_err <- sd(x) / sqrt(length(x))	
	
	return(st_err)
	}
```

    
Abstract
===============================================================================
  
Biodiversity at the metacommunity scale is typically influenced by a number of environmental, spatial, biotic, and stochastic factors. At the same time, populations of individual species are evolving in ways that can be impacted by the same factors, as sites present different selection pressures and site connectivity can impact gene flow and genetic drift. Identifying the relative impacts of environmental, spatial, biotic, and other drivers of community composition across spatial and temporal scales has been greatly facilitated by joint species distribution models, but these models have not yet considered the role that evolution can play in driving changes in composition. I used Heirarchical Models of Species Communities (HMSC) to analyze data from a simulation model of an evolving metacommunity, in order to establish whether these models can sufficiently quantify the contribution of phenotypic evolution for metacommunity composition. The models successfully partitioned variance contributed by environmental, spatial, and phenotypic drivers, and also estimated site- and year-specific covariance. I also included estimates for eco-evolutionary interactions, and the model successfully estimated their role as well. The study of eco-evolutionary dynamics may require data that reflects numerous complex, interacting processes and its necessary to have flexible, generalized statistical models to analyze this data. HMSC models present one promising path for analysis of eco-evolutionary dynamics in multi-species communities.

Introduction
================================================================================

Analysis of biodiversity at large spatial scales can be complex, because numerous abiotic factors, spatial structure and connectivity, interactions between species, and also stochastic processes such as drift and priority effects operate and determine observed patterns. Statistical models in ecology have made tremendous progress in reflecting these numerous ecological processes at multiple scales, and there are now a diversity of joint species distribution models (Pollock et al. 2014 [@Pollock2014]; Pichler & Hartig 2021 [@Pichler2021]) or multi-species occupancy models (REF; Devarajan et al. 2020). These models can incorporate critical components that structure variance in biological data such as observer, measurement, and process error, error propagation, the existence of present but undetected species or life stages (REF) and other forms of imperfect detection (REF). Many of these models increasingly have implementations in R packages (e.g. spOccupancy, Doser et al. 2022), and there are intriguing extensions of these occupancy models with consideration of the error and data types particularly associated with eDNA (e.g. EDNAOCCUPANCY, Dorazio & Erickson 2018) and citizen science data (Altwegg & Nichols 2019).

In addition to ecological processes, biodiversity at different levels of ecological organization – populations, communities, and ecosystems – are partially determined by the genotypic and phenotypic properties of organisms as well. These ecological processes can impact selection on genes and phenotypes, potentially resulting in dynamics feedback loops between ecological and evolutionary processes (Lion 2018; Barbour et al. 2022). Although an increasing number of theoretical (REF) and empirical studies have evaluated the impacts of evolutionary dynamics for community assebmly and metacommunity dynamics (REF), analytical methods to consider this additional complexity lag behind the scope of data collected in eco-evolutionary studies. A series of methods papers (Hairston et al. 2005; Ellner et al. 2011; Govaert et al. 2016) has made progress in utilizing an ANOVA framework to partition variance (in phenotypes or in other ecological response variables) across contributing ecological and evolutionary components. These approaches have been applied to categorical ecological and evolutionary treatments with two levels. For example, the study of terHorst et al. (2014) evaluated the impacts of a categorical evolutionary treatment, where host plants were experimentally adapted to a dry or wet soil environment, and a categorical environmental treatment, where experiments were conducted in a dry or wet soil environment, for bacterial and fungal community richness and diversity. Hiltunen and Becks (2014) compared the relative importance of the (ecological) change in prey density and the (evolutionary) change in prey defense traits for the change in predator density from one time point to the next. However, these methods are ultimately limited by the same requirements that can limit application of ANOVA - data should follow a normal distribution, the processes that structure the target response variable must be linear and additive, and complicated structuring mechanisms must be reduced into one or a few target categories labeled as ‘ecology’ or ‘evolution’. Flexible models, which can vary depending on the mechanisms and structure of the diverse kinds of data that most studies of eco-evolutionary dynamics will collect, are needed for rigorous inference about eco-evolutionary processes. These models should consider the mechanistic basis of data structure, with realistic models of variance and uncertainty, and ideally can be used to make predictions about future states of the system.

Two existing statistical models are well suited for analysis of eco-evolutionary data at the microevolutionary and metacommunity scale. Lasky et al. (2020) developed an integrated reaction norm model, linking genetic, phenotypic, and demographic processes, and Benito Garzón et al. (2019) presented a species distribution model with local adaptation and phenotypic plasticity ($\Delta$ SDMs). The model of Lasky et al. is an excellent candidate for spatially complex population dynamics, and awaits an extension to the multispecies level. The $\Delta$ SDM models described by Benito Garzón et al. truly disentangle the role that plastic and evolutionary trait divergence can play in species distributions, but they also require common garden experimental data across sites to estimate these effects. Data typically collected in a metacommunity survey (of eukaryotes, which thus focuses on the species level) may only be time series of population size and trait values, with surveys of environmental properties and spatial connectivity as potential predictors.

One particular metacommunity statistical model, the Hierarchical Modelling of Species Communities (HMSC) framework (Ovaskainen et al. 2017; Tikhonov et al. 2020), was built explicitly to consider the multitude of processes that can structure species occupancy and abundance data across time and space and is thus well suited to consider analysis of metacommunity eco-evolutionary data (Leibold et al. 2022). This model of environmental filtering via variation and covariation in how species respond to their environment considers the impacts of traits and phylogenetic relationships, and uses latent variables to account for the numerous unobserved environmental and spatial features that are difficult to exhaustively measure in community data. The associated R package has immense flexibility and accompanying data analysis examples and code, and has been applied to study environmental responses of diverse assemblages of organisms (REF). In this study, I use a simulation of an evolving metacommunity model to generate realistic time series of population sizes and mean trait values for multiple species in a spatially and environmentally complex landscape. I then use HMSC to analyze the resulting data, to determine whether HMSC can successfully estimate the impacts of trait evolution for community composition, and to generate relative contributions of fixed environmental, spatial, and trait evolution drivers as well as random effects of spatial and temporal covariance among species. Finally, in order to determine whether HMSC is useful for hypothesis testing about the drivers of eco-evolutionary dynamics in communities in a landscape, I also conducted a few numerical experiments with the evolving metacommunity simulation - I varied the degree of environmental fluctuations in the landscape, and I varied the strength of species interactions, to determine whether these potential drivers of increased selection pressure alter the importance of evolution for metacommunity composition. For these experiments, I hypothesized that XX and YY. I found that XXXX.

Methods
================================================================================

**Simulation model**

Population growth for species in the metacommunity simulation follows a Leslie-Gower model (a discrete-time version of a Lotka-Volterra model; Beverton & Holt 1957; Leslie & Gower 1958). I consider the impact of trait evolution for growth using a discrete time quantitative genetic model of evolutionary rescue (Gomulkiewicz & Holt 1995). The model for population size is as follows:

$$ N_{i,t+1} =\frac{\hat{W}e^ \frac{-[(\frac{w+(1-h^2)P} {P+w})(E-x_t)]^2}{2(P+w)}N_{i,t}} {1 + \alpha_{ii}N_{i,t} + \sum_{j \neq i}^{S} \alpha_{ij}N_{j,t}} $$
where $N_i,t$ is the population size of species *i* at time *t*, \( \hat{W} \) is calculated as \( \hat{W}=W_{max}\sqrt(\frac{w}{P+w}) \), \(W_{max}\) is the species' maximum per-capita growth rate, *w* is the width of the Gaussian fitness function (which determines the strength of selection), *P* is is the width of the distribution of the phenotype *x*, $h^2$ is the heritability of the trait *x*, *E* is the local environmental optimum trait value, $x_{i,t}$ is the trait value of species *i* at time *t*, $\alpha_{ii}$ is the intraspecific competition coefficient (the per capita impact of species *i* on itself) and $\alpha_{ij}$ is the interspecific competition coefficient. Populations have a critical density $N_c$, below which the population is subject to extinction due to demographic stochasticity at a probability of *p* (Gomulkiewicz & Holt 1995).

This model was used in Pantel & Becks (2023) to evaluate the consequences of adaptive evolution for coexistence in a three-species system. To expand this model to a metacommunity, I consider the evolution of multiple species (*S* = 15) in a landscape of patches (*k* = 50). The patches have values of an environmental property *E* (drawn from a uniform distribution ranging from 0 to 1) that determines the local optimum phenotype *E*, i.e. where species experience their absolute fitness $W_{max}$, and patches also have spatial locations *X* and *Y* (both drawn from U(0, 1)). The patches thus have a connectivity matrix **D** (here given by their Euclidean distance), as well as a connectivity matrix **C** that is a Gaussian function of **D** and a species dispersal rate $d_i$.

To simulate phenotypic evolution as well as species growth and competition in the landscape, I used parameter values of \(W_{max}\) = 2, *P* = 1, *w* = 10, $N_c$ = 100, and *p* = 0.001. The simulated metacommunity was initialized in a way that mimics community assembly in small vernal pools that periodically flood (and thus are reset seasonally). In the simulated pool system, local communities are drawn at random from the regional species pool, and thus their initial degree of maladaptation in the pool is initially random as well. The initial species richness of each site $s_{0k}$ was drawn from a random Poisson distribution, $s_{0k} \sim Pois(0.75)$, the initial population size for all species $N_{0i} \sim Pois(10)$, and the initial degree of maladaptation \(\beta_{i0} \sim Gamma(0.75,1)\). From this \(\beta_{i0}\), the initial distance to the local patch's optimum phenotype was calculated as $d_{i0}=\sqrt{B_{i0}(w+P)}$ and the initial trait value for each species $x_{i0}$ was calculated by subtracting $d_{i0}$ from the lowest site environmental value $E_k$.

The species interaction matrix was fixed throughout the simulation, with \(\alpha_{ii} = 0.00125\) and \(\alpha_{ij} \sim U(0.0015,1)\). After draws for all random parameter values, the same resulting initial community was used for all simulations, to allow direct comparison across dispersal and heritability values (Figure \@ref(fig:figS1)). Simulations were run across a range of dispersal values (identical for all species; *d* = 0, $10^{-9},10^{-8},10^{-7},10^{-6},10^{-5},10^{-4},10^{-3},10^{-2}$, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1) and heritability values (identical for all species: $h^2$ = 0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1). The simulations were run in MATLAB (version R2022a) for 1000 time steps and produced records of $N_{ikt}$ and $x_{ikt}$.

**Statistical model**

To determine the relative influence of environmental and spatial properties, population dynamics, and evolutionary dynamics for community structure, I applied hierarchical modelling of species communities (HMSC, Ovaskainen et al. 2017; Tikhonov et al. 2020) to model the abundance at each site and year for each species $N_{ikt}$. The abundance values were modeled as $N_{ikt} \sim N(L_{ikt},\sigma_2)$, where the linear predictors **L** are the sum of fixed and random effects **L^F^** + **L^R^** (Tikhonov et al. 2020). The fixed effects were (1) $E_k$, the value of the site’s environmental parameter, (2) the value of each species' population size the time step before $N_{ik,t-1}$, (3) the absolute value of the change in each species' trait value from the previous time step to the next $|\Delta x_{ik,t-1 \to t}|$, (4) and an interaction term for population size by change in trait value $N_{ik,t-1} \times |\Delta x_{ik,t-1 \to t}|$, which led to a total of 46 predictors. The random effects were modeled at the site-level ($\epsilon_{ik} \sim N(0, \Omega^S)$, where $\Omega^S$ is the site species-to-species covariance matrix) and at the day level ($\epsilon_{it} \sim N(0, \Omega^T)$, where $\Omega^T$ is the time species-to-species covariance matrix) using a latent variable approach. In this approach, species-to-species covariance matrices are computed as $\Omega = \lambda \intercal \lambda$, where $\lambda$ are the loadings of each species with latent variables, and latent variables are modeled as $\epsilon_{ik} = \sum_B \eta_{kB} \lambda_{Bi}$ and $\epsilon_{it} = \sum_B \eta_{tB} \lambda_{Bi}$ for *B* latent variables considered (Ovaskainen et al. 2016). The spatial latent variables represent a spatial model, where species respond to some latent spatial predictor associated with the *xy* coordinates of the site (Tikhonov et al. 2020 [@Tikhonov2020]). Analysis and was conducted in R (version 4.1.1) using packages ‘Hmsc’, 'R.matlab', and XX (Bengtsson 2022; Tikhonov et al. 2022; XX).

Results
===============================================================================

The simulation model followed population size and trait value dynamics for species in the landscape across 1000 time steps, and results depended on the dispersal level and heritability values (Figure \@ref(fig:fig1)). For dispersal, results matched predictions of existing metacommunity models demonstrating that diversity is higher for intermediate rates of dispersal (as species can increasingly reach more suitable patches at intermediate dispersal, but then experience mass effects at higher dispersal levels; Mouquet & Loreau 2003 [@Mouquet2003]; Figure \@ref(fig:fig2)), and that among-site similarity (measured as the average among-site Hellinger distance; Legendre & Gallagher 2001 [@Legendre2001]) decreases with increasing dispersal level (Figure \@ref(fig:fig3)). The inclusion of trait heritability did have a strong effect on community diversity, although there was no indication that increasing heritability beyond $h^2 = 0.1$ had any impact (Figure \@ref(fig:figS2)).

Discussion
================================================================================

I have analysed data collected by Herman Bumpus [@Bumpus1898] on the relationship between sparrow (*Passer domesticus*) total length and surival following an unusually severe storm. I found that sparrows that died in the storm were longer than sparrows that survived, which suggests that higher sparrow body length decreased survival. Of course, it is not possible to definitively conclude a causal relationship between any aspect of body size and sparrow survival<!--- BD Note: maybe explain this better --->, and even the available data collected by Bumpus would permit a more thoughtful analysis than that conducted in this study (see [Appendix Table 1](#appendix)). 

<!---

Here is one way to add some more detailed comments into the manuscript itself, though this can also be done within the text (see above). 

--->

Overall, this document demonstrates how high quality, professional looking documents can be written using Rmarkdown. The [underlying code](https://github.com/StirlingCodingClub/Manuscripts_in_Rmarkdown/blob/master/ms.Rmd) for this manuscript is publicly available, along with [accompanying notes](https://stirlingcodingclub.github.io/Manuscripts_in_Rmarkdown/Rmarkdown_notes.html) to understand how it was written. By using Rmarkdown to write manuscripts, authors can more easily use version control (e.g., git) throughout the writing process. The ability to easily integrate citations though BibTeX, LaTeX tools, and dynamic R code can also make writing much more efficient and more enjoyable. Further, obtaining the benefits of using Rmarkdown does not need to come with the cost of isolating colleagues who prefer to work with Word or LaTeX because Rmarkdown can easily be converted to these formats (in the case of Word, with the push of a button). By learning all of the tools used in this manuscript, readers should have all of the necessary knowledge to get started writing and collaborating in Rmarkdown.


References
===============================================================================

<div id="refs"></div>

<a name="appendix">Figures & Tables</a>
================================================================================

```{r fig1, echo = FALSE, eval = TRUE, fig.width = 5, fig.height = 5, fig.cap = "Time series of population size (*y*-axis) over time (*x*-axis) for all species in 5 of 50 total patches, for varying levels of dispersal *d* and heritability $h^2$. All patches have a distinct value for *E*, the environmental parameter (that determines the local population mean fitness; here *E* = 0.60198194, 0.45054160, 0.08382138, 0.07596669, and 0.23991615 for patches from top to bottom row). Each of the *s* = 15 species is plotted with a unique color. The left column has no dispersal (*d*=0) and no evolution ($h^2$=0). The middle column includes intermediate dispersal (*d* = $10^-3$) and no evolution, while the third column has intermediate dispersal and evoltution ($h^2$=0.1)."}
d_lev <- c("d_zero","d_minus9","d_minus8","d_minus7","d_minus6","d_minus5","d_minus4","d_minus3","d_minus2","d_01","d_02","d_03","d_04","d_05","d_06","d_07","d_08","d_09","d_10")
h_lev <- c("h_0_","h_01_","h_02_","h_03_","h_04_","h_05_","h_06_","h_07_","h_08_","h_09_","h_10_")
setwd("data/")
result <- paste(h_lev[1],d_lev[1],"_res.mat",sep="")
r1  <- R.matlab::readMat(toString(result))$N
result <- paste(h_lev[1],d_lev[8],"_res.mat",sep="")
r2  <- R.matlab::readMat(toString(result))$N
result <- paste(h_lev[2],d_lev[8],"_res.mat",sep="")
r3  <- R.matlab::readMat(toString(result))$N

## Plot of Patch 6,11,12,46,47 community dynamics over time
#cl <- grDevices::colors(distinct = TRUE)
#mycols2 <- sample(cl, 15)
mycols2 <- c("maroon4","coral3","peachpuff3","gray47","orange3","darkorange","gray33","lightgoldenrod2","gray96","cadetblue4","gray40","lightseagreen","darkorchid4","midnightblue","rosybrown1" )

par(mfcol=(c(5,3)))
par(mar=c(2,2,1.5,1))
k <- 1
for(j in c(6,11,12,46,47)){
    plot(eval(parse(text=paste("r",k,sep="")))[j,1,],col=mycols2[1],ylim=c(0,800),axes=FALSE,type="n",ylab=NA,xlab=NA)
  for(i in 1:15){
    points(eval(parse(text=paste("r",k,sep="")))[j,i,],col=mycols2[i])
  }
  if (j %in% 6){
    axis(2,col="grey40",col.axis="grey20",at = c(0,250,500,750,1000))
    title(main=expression("d = 0, " ~ "h"^2 ~ "= 0"),cex.sub=2)
  }
  if (j %in% c(11,12,46)){
    axis(2,col="grey40",col.axis="grey20",at = c(0,250,500,750,1000))
  }
  if (j %in% c(47)){
    axis(1,col="grey40",col.axis="grey20",at = c(0,200,400,600,800))
    axis(2,col="grey40",col.axis="grey20",at = c(0,250,500,750,1000))
  }
}

k <- 2
for(j in c(6,11,12,46,47)){
    plot(eval(parse(text=paste("r",k,sep="")))[j,1,],col=mycols2[1],ylim=c(0,800),axes=FALSE,type="n",ylab=NA,xlab=NA)
  for(i in 1:15){
    points(eval(parse(text=paste("r",k,sep="")))[j,i,],col=mycols2[i])
  }
  if (j %in% 6){
    title(main=expression("d = 10"^-3 ~ ", h"^2 ~ "= 0"),cex.sub=2)
  }
  if (j %in% c(47)){
    axis(1,col="grey40",col.axis="grey20",at = c(0,200,400,600,800))
    }
}

k <- 3
for(j in c(6,11,12,46,47)){
    plot(eval(parse(text=paste("r",k,sep="")))[j,1,],col=mycols2[1],ylim=c(0,800),axes=FALSE,type="n",ylab=NA,xlab=NA,xaxs="i",yaxs="i")
  for(i in 1:15){
    points(eval(parse(text=paste("r",k,sep="")))[j,i,],col=mycols2[i])
  }
  if (j %in% 6){
    title(main=expression("d = 10"^-3 ~ ", h"^2 ~ "= 0.1"),cex.sub=2)
  }
  if (j %in% c(47)){
    axis(1,col="grey40",col.axis="grey20",at = c(0,200,400,600,800))
    }
}
```


\newpage


```{r fig2, echo = FALSE, eval = TRUE, warning=FALSE, message=FALSE, fig.width = 8, fig.height = 5, fig.cap = "Inverse Simpson's diversity ($^2D$) at the local (average $\\alpha$ value across all 50 sites, with error bars at ± 1 standard error) and regional ($\\gamma$) level, and turnover between sites (average $\\beta$ value across all 50 sites, with error bars at ± 1 SE) for $h^2$=0 (solid lines) and $h^2$=0.1 (dashed lines), indicating that local adaptation rescues numerous species that would otherwise become extinct."}
div_1000 <- array(NA,dim=c(19,11,3,3),dimnames=list(c("d_zero","d_minus9","d_minus8","d_minus7","d_minus6","d_minus5","d_minus4","d_minus3","d_minus2","d_01","d_02","d_03","d_04","d_05","d_06","d_07","d_08","d_09","d_10"),c("h_0_","h_01_","h_02_","h_03_","h_04_","h_05_","h_06_","h_07_","h_08_","h_09_","h_10_"),c("alpha","gamma","beta"),c("mean","CV","SDE")))

setwd("data/")
for(i in 1:length(d_lev)){
  for(j in 1:2){
    ## Read in population size values
    result <- paste(h_lev[j],d_lev[i],"_res.mat",sep="")
    r <- R.matlab::readMat(toString(result))$N[,,1000]    # alpha
    div_1000[i,j,1,1] <- mean(diversity(r[rowSums(r) != 0,],index="invsimpson")) # mean
    div_1000[i,j,1,2] <- CV(diversity(r[rowSums(r) != 0,],index="invsimpson")) # CV
    div_1000[i,j,1,3] <- standard_error(diversity(r[rowSums(r) != 0,],index="invsimpson")) # SE
    
    # gamma
    div_1000[i,j,2,1] <- if (is.null(dim(r[rowSums(r) != 0,])[1])) {NA} else if (dim(r[rowSums(r) != 0,])[1] < 2) {NA} else {diversity(colSums(r[rowSums(r) != 0,]),index="invsimpson")}
    
    # beta
    div_1000[i,j,3,1] <- if (is.null(dim(r[rowSums(r) != 0,])[1])) {NA} else if (dim(r[rowSums(r) != 0,])[1] < 2) {NA} else {mean(diversity(colSums(r[rowSums(r) != 0,]),index="invsimpson") / diversity(r[rowSums(r) != 0,],index="invsimpson"))}
      
    div_1000[i,j,3,2] <- if (is.null(dim(r[rowSums(r) != 0,])[1])) {NA} else if (dim(r[rowSums(r) != 0,])[1] < 2) {NA} else {CV(diversity(colSums(r[rowSums(r) != 0,]),index="invsimpson") / diversity(r[rowSums(r) != 0,],index="invsimpson"))}
      
    div_1000[i,j,3,3] <- if (is.null(dim(r[rowSums(r) != 0,])[1])) {NA} else if (dim(r[rowSums(r) != 0,])[1] < 2) {NA} else {standard_error(diversity(colSums(r[rowSums(r) != 0,]),index="invsimpson") / diversity(r[rowSums(r) != 0,],index="invsimpson"))}
  }
}

## Plot of mean and CV for gamma diversity
##t1000 only
plot(1:length(d_lev),div_1000[,1,2,1],type="n",ylim=c(0,15), xaxt="n", yaxt="n",xlab="dispersal (d)",ylab="diversity",main="")
axis(1, at=1:19, labels=c(0,expression(10^-9),expression(10^-8),expression(10^-7),expression(10^-6),expression(10^-5),expression(10^-4),expression(10^-3),expression(10^-2),0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1), las=1)
axis(2, at=c(0:15), las=1)
points(1:length(d_lev),div_1000[,1,2,1],pch=19,col="black",cex=2, type="b") # gamma

points(1:length(d_lev),div_1000[,1,3,1],pch=21,cex=2, type="b") # beta
arrows(1:length(d_lev), div_1000[,1,3,1], 1:length(d_lev), div_1000[,1,3,1]+div_1000[,1,3,3], length=0.05, angle=90, code=2, lwd=1, col="black")
arrows(1:length(d_lev), div_1000[,1,3,1], 1:length(d_lev), div_1000[,1,3,1]-div_1000[,1,3,3], length=0.05, angle=90, code=2, lwd=1, col="black")

points(1:length(d_lev),div_1000[,1,1,1],pch=19,col="darkgray",cex=2, type="b") # alpha
arrows(1:length(d_lev), div_1000[,1,1,1], 1:length(d_lev), div_1000[,1,1,1]+div_1000[,1,1,3], length=0.05, angle=90, code=2, lwd=1, col="black")
arrows(1:length(d_lev), div_1000[,1,1,1], 1:length(d_lev), div_1000[,1,1,1]-div_1000[,1,1,3], length=0.05, angle=90, code=2, lwd=1, col="black")

# Add h2 = 0.1
# gamma
points(1:length(d_lev),div_1000[,2,2,1],pch=19,col="black",cex=2)
lines(1:length(d_lev),div_1000[,2,2,1],lty=5)
# beta
points(1:length(d_lev),div_1000[,2,3,1],pch=21,cex=2)
lines(1:length(d_lev),div_1000[,2,3,1],lty=5)

arrows(1:length(d_lev), div_1000[,2,3,1], 1:length(d_lev), div_1000[,2,3,1]+div_1000[,2,3,3], length=0.05, angle=90, code=2, lwd=1, col="black")
arrows(1:length(d_lev), div_1000[,2,3,1], 1:length(d_lev), div_1000[,2,3,1]-div_1000[,2,3,3], length=0.05, angle=90, code=2, lwd=1, col="black")
# alpha
points(1:length(d_lev),div_1000[,2,1,1],pch=19,col="darkgray",cex=2)
lines(1:length(d_lev),div_1000[,2,1,1],lty=5)
arrows(1:length(d_lev), div_1000[,2,1,1], 1:length(d_lev), div_1000[,2,1,1]+div_1000[,2,1,3], length=0.05, angle=90, code=2, lwd=1, col="black")
arrows(1:length(d_lev), div_1000[,2,1,1], 1:length(d_lev), div_1000[,2,1,1]-div_1000[,2,1,3], length=0.05, angle=90, code=2, lwd=1, col="black")

legend("topright",legend = c(expression(gamma),expression(beta),expression(alpha)), pt.bg=c("black","white","gray"),pch=21,pt.cex=1.5,bty="n",y.intersp=1)
```


\newpage


```{r fig3, echo=FALSE, fig.show="hold", out.width="25%", fig.cap = "(A) Plot with among-site similarity plotted across dispersal levels for $h^2$=0 and $h^2$=0.1, for dispersal levels XXX. (B) Plot with average among-site similarity (error bars at ± 1 standard error are given but very small) across $h2$ levels."}
setwd("data/")
## Network similarity plot
cd <- array(NA,dim=c(19,11,2),dimnames=list(c("d_zero","d_minus9","d_minus8","d_minus7","d_minus6","d_minus5","d_minus4","d_minus3","d_minus2","d_01","d_02","d_03","d_04","d_05","d_06","d_07","d_08","d_09","d_10"),c("h_0_","h_01_","h_02_","h_03_","h_04_","h_05_","h_06_","h_07_","h_08_","h_09_","h_10_"),c("mean","SE")))

## Plot of among-site community similarity
# Plot labels
l <- rep(NA,8)
l[1] <- expression("d = 0")
l[2] <- expression("d = 10^-5")
l[3] <- expression("d = 10^-4")
l[4] <- expression("d = 10^-3")
l[5] <- expression("d = 0.1")
l[6] <- expression("d = 0.5")
l[7] <- expression("d = 0.8")
l[8] <- expression("d = 1")
count <- 1

par(mfrow=(c(8,2)))
par(mar=c(2,2,1.5,1))
for(j in 1:2){
  for(i in c(1,6,7,8,10,14,17,19)){
    count <- count+1
    ## Read in population size values
    result <- paste(h_lev[j],d_lev[i],"_res.mat",sep="")
    r <- R.matlab::readMat(toString(result))$N[,,1000]
    xy <- R.matlab::readMat(toString(result))$xy
  
    ##Hellinger-distance transform community data
    comm_hell <- decostand(r, "hellinger")
    comm_hell <- vegdist(comm_hell, "euclidean")
    comm_hell <- as.matrix(comm_hell)
    cd[i,j,1] <- mean(comm_hell)
    cd[i,j,2] <- standard_error(comm_hell)
  
    ##W1 = community
    ##Construct similarity graphs
    # Convert all values where one site has 0 species present to distance 0
    s1000 <- rowSums(r)
    s1000[s1000 > 0] <- 1
    for(k in 1:50){
      for(b in 1:50){
        if(s1000[k] == 0 | s1000[b] == 0){comm_hell[k,b] <- 1}
      }
    }
    diag(comm_hell) <- 1
  
    ## affinity graph
    K <- 49
    alpha <- 0.5
    W1 <- affinityMatrix(comm_hell, K, alpha)
  
    comm_dist <- data.frame(t(combn(1:50,2))[,1])
    comm_dist$to <- t(combn(1:50,2))[,2]
    comm_dist$dist <- as.numeric(W1[lower.tri(W1, diag=F)])
    colnames(comm_dist) <- c('from', 'to', 'dist')
    # White colors for edges between sites with no species present
    comm_dist$from_s <- NA
    comm_dist$to_s <- NA
    comm_dist$color <- "none"
    for(k in 1:50){
      comm_dist$from_s[comm_dist$from == k] <- s1000[k]
      comm_dist$to_s[comm_dist$to == k] <- s1000[k]
    }
    for(k in 1:nrow(comm_dist)){
      ifelse(comm_dist$from_s[k] + comm_dist$to_s[k] < 2,comm_dist$color[k] <- "white",comm_dist$color[k] <- "red")
    }
  
    qgraph(comm_dist[,1:3], esize=5, vsize = 2, gray=F, edge.color = comm_dist$color, directed=F, labels = 1:50, layout = xy, maximum = 10.98745, minimum = .035, label.cex=3, title = l[count])
  }
}
```


\newpage


<a name="appendix">Appendix 1</a>
================================================================================

```{r figS1, echo = FALSE, eval = TRUE, fig.width = 5, fig.height = 5, fig.cap = "Figure S1. Spatial maps showing position of all 50 sites in the simulation, their value for the single environmental variable E, and their value for initial Simpson's diversity at the beginning of the simulation.", warning=FALSE,message=FALSE}

## Figure S1. Plot of location of sites in landscape, associated E values, and associated diversity values
setwd("data/")
result <- paste(h_lev[2],d_lev[8],"_res.mat",sep="")
dat  <- R.matlab::readMat(toString(result))

layout(matrix(c(1,3,2,4),ncol=2), width = c(2,1),height = c(1,1))
pal <- colorRampPalette(c("white", "blue"))
plot(dat$xy,col="grey90", fill=TRUE, warnings=F, xlab="X coord",ylab="Y coord")
options(warn=0)
points(dat$xy[,1], dat$xy[,2],pch = 21,bg = pal(10)[as.numeric(cut(dat$E,breaks = 10))],col="black")

legend_image <- as.raster(matrix(rev(pal(10)), ncol=1))
plot(c(0,2),c(0,1),type = 'n', axes = F,xlab = '', ylab = '', main = 'E value')
text(x=1.5, y = seq(0,1,l=5), labels = seq(0,1,l=5))
rasterImage(legend_image, 0, 0, 1, 1) ## set new for overplot w/ next plot

pal <- colorRampPalette(c("white", "orange"))
a  <- vegan::diversity(dat$N[,,1],index="invsimpson")
a[is.finite(a)==FALSE] <- 0
plot(dat$xy,col="grey90", fill=TRUE, warnings=F, xlab="X coord",ylab="Y coord")
options(warn=0)
points(dat$xy[,1], dat$xy[,2],pch = 21,bg = pal(10)[as.numeric(cut(a,breaks = 10))],col="black")

legend_image <- as.raster(matrix(rev(pal(10)), ncol=1))
plot(c(0,2),c(0,1),type = 'n', axes = F,xlab = '', ylab = '', main = 'inverse Simpson diversity')
text(x=1.5, y = seq(0,1,l=6), labels = seq(0,15,l=6))
rasterImage(legend_image, 0, 0, 1, 1) ## set new for overplot w/ next plot
```


\newpage


```{r figS2, echo=FALSE, fig.show="hold", fig.cap = "Plots with (A) gamma, (B) alpha, and (C) beta diversity across levels of dispersal (x-axis), for values of heritability ranging from 0-1."}
setwd("data/")
## Inverse Simpson's diversity across additional heritability levels
for(i in 1:length(d_lev)){
  for(j in 3:length(h_lev)){
    ## Read in population size values
    result <- paste(h_lev[j],d_lev[i],"_res.mat",sep="")
    r <- R.matlab::readMat(toString(result))$N[,,1000]    # alpha
    div_1000[i,j,1,1] <- mean(diversity(r[rowSums(r) != 0,],index="invsimpson")) # mean
    div_1000[i,j,1,2] <- CV(diversity(r[rowSums(r) != 0,],index="invsimpson")) # CV
    div_1000[i,j,1,3] <- standard_error(diversity(r[rowSums(r) != 0,],index="invsimpson")) # SE
    
    # gamma
    div_1000[i,j,2,1] <- if (is.null(dim(r[rowSums(r) != 0,])[1])) {NA} else if (dim(r[rowSums(r) != 0,])[1] < 2) {NA} else {diversity(colSums(r[rowSums(r) != 0,]),index="invsimpson")}
    
    # beta
    div_1000[i,j,3,1] <- if (is.null(dim(r[rowSums(r) != 0,])[1])) {NA} else if (dim(r[rowSums(r) != 0,])[1] < 2) {NA} else {mean(diversity(colSums(r[rowSums(r) != 0,]),index="invsimpson") / diversity(r[rowSums(r) != 0,],index="invsimpson"))}
      
    div_1000[i,j,3,2] <- if (is.null(dim(r[rowSums(r) != 0,])[1])) {NA} else if (dim(r[rowSums(r) != 0,])[1] < 2) {NA} else {CV(diversity(colSums(r[rowSums(r) != 0,]),index="invsimpson") / diversity(r[rowSums(r) != 0,],index="invsimpson"))}
      
    div_1000[i,j,3,3] <- if (is.null(dim(r[rowSums(r) != 0,])[1])) {NA} else if (dim(r[rowSums(r) != 0,])[1] < 2) {NA} else {standard_error(diversity(colSums(r[rowSums(r) != 0,]),index="invsimpson") / diversity(r[rowSums(r) != 0,],index="invsimpson"))}
  }
}

## Plot results across heritability levels
## Plot of mean and SE for gamma diversity
##t1000 only
par(mfcol=c(3,1),mai = c(0.3, 0.3, 0.1, 0.1))
# gamma
plot(1:length(d_lev),div_1000[,1,2,1],type="n",ylim=c(0,15), xaxt="n", yaxt="n",xlab="dispersal (d)",ylab="diversity",main="")
axis(1, at=1:19, labels=c(0,expression(10^-9),expression(10^-8),expression(10^-7),expression(10^-6),expression(10^-5),expression(10^-4),expression(10^-3),expression(10^-2),0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1), las=1)
axis(2, at=c(0:15), las=1)
# h2=0
points(1:length(d_lev),div_1000[,1,2,1],pch=19,col="black",cex=.7, type="b") # gamma
#arrows(1:length(d_lev), div_1000[,1,2,1], 1:length(d_lev), div_1000[,1,2,1]+div_1000[,1,2,3], length=0.05, angle=90, code=2, lwd=1, col="black")
#arrows(1:length(d_lev), div_1000[,1,2,1], 1:length(d_lev), div_1000[,1,2,1]-div_1000[,1,2,3], length=0.05, angle=90, code=2, lwd=1, col="black")
# loop across h2
for(i in 2:length(h_lev)){
  points(1:length(d_lev),div_1000[,i,2,1],pch=19,col="black",cex=.7, type="b") # gamma
  #arrows(1:length(d_lev),div_1000[,i,2,1],1:length(d_lev),div_1000[,i,2,1]+div_1000[,i,2,3],length=0.05, angle=90, code=2, lwd=1,col="black")
  #arrows(1:length(d_lev),div_1000[,i,2,1],1:length(d_lev),div_1000[,i,2,1]-div_1000[,i,2,3],length=0.05, angle=90, code=2, lwd=1, col="black")
}

# alpha
plot(1:length(d_lev),div_1000[,1,2,1],type="n",ylim=c(0,15), xaxt="n", yaxt="n",xlab="dispersal (d)",ylab="diversity",main="")
axis(1, at=1:19, labels=c(0,expression(10^-9),expression(10^-8),expression(10^-7),expression(10^-6),expression(10^-5),expression(10^-4),expression(10^-3),expression(10^-2),0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1), las=1)
axis(2, at=c(0:15), las=1)
# h2=0
points(1:length(d_lev),div_1000[,1,1,1],pch=19,col="black",cex=.7, type="b") # alpha
#arrows(1:length(d_lev), div_1000[,1,1,1], 1:length(d_lev), div_1000[,1,1,1]+div_1000[,1,1,3], length=0.05, angle=90, code=2, lwd=1, col="black")
#arrows(1:length(d_lev), div_1000[,1,1,1], 1:length(d_lev), div_1000[,1,1,1]-div_1000[,1,1,3], length=0.05, angle=90, code=2, lwd=1, col="black")
# loop across h2
for(i in 2:length(h_lev)){
  points(1:length(d_lev),div_1000[,i,1,1],pch=19,col="black",cex=.7, type="b") # alpha
  #arrows(1:length(d_lev),div_1000[,i,1,1],1:length(d_lev),div_1000[,i,1,1]+div_1000[,i,1,3],length=0.05, angle=90, code=2, lwd=1,col="black")
  #arrows(1:length(d_lev),div_1000[,i,1,1],1:length(d_lev),div_1000[,i,1,1]-div_1000[,i,1,3],length=0.05, angle=90, code=2, lwd=1, col="black")
}

# beta
plot(1:length(d_lev),div_1000[,1,2,1],type="n",ylim=c(0,15), xaxt="n", yaxt="n",xlab="dispersal (d)",ylab="diversity",main="")
axis(1, at=1:19, labels=c(0,expression(10^-9),expression(10^-8),expression(10^-7),expression(10^-6),expression(10^-5),expression(10^-4),expression(10^-3),expression(10^-2),0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1), las=1)
axis(2, at=c(0:15), las=1)
# h2=0
points(1:length(d_lev),div_1000[,1,3,1],pch=19,col="black",cex=.7,type="b")
#arrows(1:length(d_lev), div_1000[,1,3,1], 1:length(d_lev), div_1000[,1,3,1]+div_1000[,1,3,3], length=0.05, angle=90, code=2, lwd=1, col="black")
#arrows(1:length(d_lev), div_1000[,1,3,1], 1:length(d_lev), div_1000[,1,3,1]-div_1000[,1,3,3], length=0.05, angle=90, code=2, lwd=1, col="black")
# loop across h2
for(i in 2:length(h_lev)){
  points(1:length(d_lev),div_1000[,i,3,1],pch=19,col="black",cex=.7,type="b")
  #arrows(1:length(d_lev),div_1000[,i,3,1],1:length(d_lev),div_1000[,i,3,1]+div_1000[,i,3,3],length=0.05, angle=90, code=2, lwd=1,col="black")
  #arrows(1:length(d_lev),div_1000[,i,3,1],1:length(d_lev),div_1000[,i,3,1]-div_1000[,i,3,3],length=0.05, angle=90, code=2, lwd=1, col="black")
}
```