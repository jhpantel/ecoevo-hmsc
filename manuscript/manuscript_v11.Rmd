---
title: "Detection of eco-evolutionary dynamics in metacommunities using Joint Species
  Distribution Models"
author:
  - Jelena H. Pantel^[Laboratoire Chrono-environnement,UMR 6249 CNRS-UFC, 16 Route de Gray, 25030 Besançon cedex, France, jelena.pantel@univ-fcomte.fr]
  - Ruben J. Hermann^[University of Duisburg-Essen, Universitätsstraße 5, 45141 Essen, Germany, ruben.hermann@uni-due.de]
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::pdf_document2:
    toc: no
    fig_caption: yes
    latex_engine: xelatex
    extra_dependencies: ["float"]
    number_sections: true
  bookdown::html_document2: default
  word_document:
    reference_docx: docx_template.docx
header-includes:
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyhead[L]{Author Pantel and Hermann}
- \fancyhead[R]{Detection of ecoevo dynamics}
- \usepackage{lineno}
- \linenumbers
linestretch: 2
link-citations: yes
linkcolor: blue
csl: the-american-naturalist.csl
bibliography: refs.bib
---

```{r setup,echo=FALSE,warning=FALSE,message=FALSE}
library(Hmsc)
```

\newpage

# Title

Detection of eco-evolutionary dynamics in metacommunities using Joint Species Distribution Models

# Abstract

XXXXX

# Introduction

Analysis of biodiversity at large spatial scales can be complex, because numerous environmental properties, spatial structure and connectivity, interactions between species, as well as stochastic processes such as drift and priority effects operate and determine observed patterns. Statistical models in ecology have made tremendous progress in reflecting these numerous ecological processes at multiple scales. There are now a diversity of joint species distribution models [JSDMs; @Pollock2014] [@Pichler2021] or multi-species occupancy models [@Devarajan2020] [@Poggiato2021], which can incorporate these diverse components that structure variance in biological data. Many of these models increasingly have implementations in R packages (e.g. spOccupancy, [@Doser2022]), and have been used to measure the relative importance of different ecological drivers in fungi, birds, mammals, phytoplankton, fish, and other taxa, from local to continental scales (e.g. [@Abrego2020] [@Antao2022] [@Keppeler2022]).

There are some remaining drivers of community composition that aren't currently reflected in these models. The dynamics of populations and communities, and resulting biodiversity patterns, are also influenced by the genotypic and phenotypic properties of organisms as well. Although traits can be considered in some JSDMs, they typically require fixed values for species' traits ([@Ovaskainen2017HMSC] [@Tikhonov2020]; but see @Abrego2024). However, ecological dynamic processes can impact selection on genes and phenotypes, potentially resulting in interactions or feedback loops between ecological and evolutionary processes [@Lion2018] [@Barbour2022]. Although an increasing number of theoretical and empirical studies have evaluated the impact of evolutionary dynamics for community assembly and metacommunity dynamics [@Loeuille2008] [@Osmond2013] [@Pantel2015] [@Toju2017], analytical methods to consider this additional complexity lag behind the scope of data collected in eco-evolutionary studies. Some methods exist that ultimately apply an ANOVA framework to partition variance in traits or growth rates across contributions of ecological and evolutionary components ([@Hairston2005] [@Ellner2011] [@Govaert2016]). These methods tend to be cited more frequently for their potential than for their actual application to empirical data (but see [@terHorst2014] [@Hiltunen2014]), because this approach is ultimately limited by the same requirements that can limit application of ANOVA - data should follow a normal distribution, the processes that structure the target response variable must be linear and additive, and complicated structuring mechanisms must be reduced into one or a few target categories labeled as 'ecology' or 'evolution'. Flexible models, which can vary depending on the mechanisms and structure of the diverse kinds of data that most studies of eco-evolutionary dynamics will collect, are needed for rigorous inference about eco-evolutionary processes [@Pantel2023].

Two existing statistical models are potentially well suited for analysis of eco-evolutionary data at the microevolutionary and metacommunity scale but also have some considerations before their application to complex community data. Lasky et al. (2020) [@Lasky2020] developed an integrated reaction norm model, linking genetic, phenotypic, and demographic processes, and Benito Garzón et al. (2019) [@Garzon2019] presented a species distribution model with local adaptation and phenotypic plasticity ($\Delta$ SDMs). The model of Lasky et al. is an excellent candidate for spatially complex population dynamics, and awaits an extension to the multispecies level. The $\Delta$ SDM models described by Benito Garzón et al. truly disentangle the role that plastic and evolutionary trait divergence can play in species distributions, but they also require common garden experimental data across sites to estimate these effects. Observational data collected in metacommunity surveys may only have observational data across sites or time points, as large-scale experimental measures of reaction norms required by the $\Delta$ SDM model may be difficult to obtain.

One particular metacommunity statistical model, the Hierarchical Modelling of Species Communities (HMSC) framework [@Ovaskainen2017HMSC] [@Tikhonov2020], explicitly considers the multitude of processes that can structure community composition across time and space [@Leibold2022] and is thus well suited to consider analysis of metacommunity eco-evolutionary data. This model of environmental filtering via variation and covariation in how species respond to their environment considers the impacts of (fixed) trait values and phylogenetic relationships, and uses latent variables to account for the numerous unobserved environmental and spatial features that are difficult to exhaustively measure in community surveys. The associated R package has immense flexibility, and has been applied to study environmental and abiotic drivers of diverse assemblages of organisms (e.g. [@Sandal2022] [@Weigel2023]). HMSC is potentially useful for studying eco-evolutionary drivers of community structure, but the model has not previously been applied to include heritable changes in trait values over time.

In this study, we use simulations of population dynamics, environmental drivers, species interactions, and trait evolution in populations, communities, at the local and metacommunity scale, to generate simulated time series of population sizes and mean trait values. We then use HMSC to analyze the resulting data, to determine whether HMSC can successfully estimate the impacts of trait evolution for community composition, and to generate relative contributions of fixed environmental, spatial, and trait evolution drivers as well as random effects of spatial and temporal covariance among species. We asked three main questions: (i) do linear statistical models (like HMSC) accurately capture the impact of non-linear population, community, and evolutionary dynamic processes?, (ii) can HMSC be used to evaluate hypothesized drivers of the relative importance of evolution for community composition at the metacommunity scale?, and (iii) can we better understand the role of evolution for community dynamics in experimental systems using HMSC?

# Methods

## Linear statistical models for one- and two-species models of growth, competition, and trait evolution

We evaluated whether linear regression models can appropriately capture the dynamics that drive species abundances in relatively simple populations and communities. We fit data generated from simulation models with increasing complexity to Bayesian linear regression models. These simulation models were (i) a single-species model of discrete-time logistic population growth, (ii) expanded to include a randomly fluctuating environmental property $E$ that impacts the species' population growth rate, (iii) a two-species model of logistic growth and competition that was then (iv) expanded to consider a randomly fluctuating environmental property, (v) and further expanded to consider evolution in a trait $x$ that is selected by the environmental property, and finally (vi) the model of two-species growth, competition, environmental change, and evolution in a spatially structured (10-patch) habitat.

For linear regression models to fit to the simulated population size data, we began with models using population size and environment as fixed effects ($N_t \sim N_{t+1} + E_t + E_t^2$), and progressed to a mixed model using environment and trait evolution as fixed effects ($N_t \sim E_t + E_t^2 + |\Delta x|$) and time and spatial distance as random effects. For consistency, all linear regression models were implemented as heirarchical Bayesian models using HMSC (Hierarchical Modelling of Species Communities [@Ovaskainen2017HMSC] [@Tikhonov2020]). HMSC uses a latent variable approach as an alternative to directly modelling species interaction coefficients, estimating a reduced number of linear combinations of species abundances that best predict future population size values. For linear models fit to data generated in simulations *iii*, *iv*, *v*, and *vi* above, the time random effect was implemented to capture species interactions (as part of the temporal species association matrix estimated by the model), and the spatial random effect was implemented in model *vi* to capture spatial covariance in abundances as a function of distance between sites. Full methodological details are given in Appendix S1. All simulations were run in R (@R2024) and HMSC models were implemented using the `Hmsc` package (@Hmsc2022).

## Evolution in metacommunities and HMSC

###Simulation model

We also simulated growth and competition dynamics for a multi-species assemblage in a patchy landscape, with site variation in one environmental property, and with evolution in a trait that is selected on by the environment. Population growth for species in the metacommunity simulation follows a Leslie-Gower model (a discrete-time version of a Lotka-Volterra model [@Beverton1957] [@Leslie1958]). We consider the impact of trait evolution for growth using a discrete time quantitative genetic model of evolutionary rescue [@Gomulkiewicz1995]. The model for population size is as follows:

$$ N_{i,t+1} =\frac{\hat{W}e^ \frac{-[(\frac{w+(1-h^2)P} {P+w})(E-x_{i,t})]^2}{2(P+w)}N_{i,t}} {1 + \alpha_{ii}N_{i,t} + \sum_{j \neq i}^{S} \alpha_{ij}N_{j,t}} $$ where $N_i,t$ is the population size of species *i* at time *t*, $\hat{W}$ is calculated as $\hat{W}=W_{max}\sqrt(\frac{w}{P+w})$, $W_{max}$ is the species' maximum per-capita growth rate, *w* is the width of the Gaussian fitness function (which determines the strength of selection, as increasing values indicate a weaker reduction in fitness with distance from optimum trait value), *P* is the width of the distribution of the phenotype *x*, $h^2$ is the heritability of the trait *x*, *E* is the local environmental optimum trait value, $x_{i,t}$ is the trait value of species *i* at time *t*, $\alpha_{ii}$ is the intraspecific competition coefficient (the per capita impact of species *i* on itself) and $\alpha_{ij}$ is the interspecific competition coefficient. Populations have a critical density $N_c$, below which the population is subject to extinction due to demographic stochasticity at a probability of *p* [@Gomulkiewicz1995].

This model was used in Pantel & Becks [@Pantel2023] to evaluate the consequences of adaptive evolution for coexistence in a three-species system. To expand this model to a metacommunity, we consider the evolution of multiple species (*S* = 15) in a landscape of patches (*k* = 50). The patches have values of an environmental property $E \sim U(0,1)$ that determines the local optimum phenotype *E* = $x_{opt}$, i.e. where species experience their absolute fitness $W_{max}$, and patches also have spatial locations *X* and *Y* (both drawn from $U(0, 1)$). The patches thus have a connectivity matrix **D** (here given by their Euclidean distance), as well as a connectivity matrix **C** that is a Gaussian function of **D** and species dispersal rate $d_i$.

We used the evolving metacommunity model to test whether landscape connectivity (the overall dispersal rate $d$) and the speed of evolution (evaluated as $h^2$) influenced the relative importance of trait evolution ($|\Delta x|$) for metacommunity composition (evaluated as $V_{|\Delta x|}$, the proportion of variation in species abundances explained by $|\Delta x|$ as estimated by the HMSC model fit to the simulated data across $d$ and $h^2$ levels). We hypothesized that the overall importance of trait evolution ($V_{|\Delta x|}$) would decrease with increasing dispersal rate - at low dispersal, locally mal-adapted species are less likely to emigrate to more optimal patches and will experience strong local selection. Population sizes in the mal-adapted populations will also likely be lower, leading to reduced relative importance of density-dependent intra- and interspecific competition. We also hypothesized that heritability ($h^2$) would mediate the relative importance of dispersal rate - at higher $h^2$, species will evolve quickly and we expected the importance of trait evolution $V_{|\Delta x|}$ to depend on the amount of time that mal-adapted populations persist. Therefore simulations run using higher $h^2$ would have decreased importance of evolution $V_{|\Delta x|}$ for community composition. For the same reason, we hypothesized generally that, for a given dispersal rate $d$, the importance of evolution $V_{|\Delta x|}$ would decrease with increasing $h^2$.

All simulations used the same parameter values ($W_{max}$ = 2, *P* = 1, *w* = 2, $N_c$ = 100, *p* = 0.001), species interaction matrix ($\alpha_{ii} = 0.00125$; $\alpha_{ij} \sim U(0.0015,1)$), and initial conditions (initial richness $s_{0k} \sim Pois(0.75)$; initial population size $N_{0i} \sim Pois(10)$; initial degree of maladaptation $\beta_{i0} \sim Gamma(0.75,1)$, initial distance to the local patch's optimum phenotype $d_{i0}=\sqrt{B_{i0}(w+P)}$, initial trait value $x_{i0} = E_k - d_{i0}$; Appendix S4). Simulations were run across a range of dispersal values (identical for all species; *d* = 0, $10^{-9},10^{-8},10^{-7},10^{-6},10^{-5},10^{-4},10^{-3},10^{-2}$, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1) and heritability values (identical for all species: $h^2$ = 0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1) for 200 time steps, producing records of $N_{ikt}$ and $x_{ikt}$.

### Statistical model

To determine the relative influence of environmental and spatial properties, intra- and interspecific population dynamics, and evolutionary dynamics for community structure, we applied hierarchical modelling of species communities (HMSC, [@Ovaskainen2017HMSC] [@Tikhonov2020]) to model the log abundance at each site and year for each species $ln(N_{ikt})$. The abundance values were modeled as $N_{ikt} \sim N(L_{ikt},\sigma_2)$, where the linear predictors **L** are the sum of fixed and random effects **L^F^** + **L^R^** [@Tikhonov2020]. The fixed effects were $E_k$, $E_k^2$, and the absolute value of the change in each species' trait value from the previous time step to the next $|\Delta x_{ik,t-1 \to t}|$. Random effects included time (the day of the sample) and space. The spatial latent variables represent a spatial model, where species respond to some latent spatial predictor associated with the *xy* coordinates of the sites [@Tikhonov2020].

### Applying HMSC on empirical data

To test the applicability of HMSC on ecological and evolutionary effects in empirical data, we applied HMSC on the experimental data of Jewel & Bell (2023) [@Jewell2023]. The authors conducted a community selection experiments in which they grew four floating and short-lived aquatic plants (the angiosperms *Lemna minor* here designated as Lm, *Spirodela polyrhiza* designated as Sp and *Wolffia columbiana* designated as Wc, and the liverwort *Ricciocarpos natans* designated as Rn) under different environmental conditions for twelve weeks. The environmental conditions were defined by three differed amount of shadings of the water pool, 3%, 12% and 50%, and different nutrient concentrations, with low (dissolved nitrogen (DN) = 200 μg L−1, dissolved phosphorous (DP) = 10 μg L−1)), medium (DN = 800 μg L−1, DP = 40 μg L−1), and high concentration (DN = 3200 μg L−1, DP = 160 μg L−1) of nutrients. They combined each shading with each nutrient level, resulting in nine different environmental conditions. Throughout the experiment they measured biweekly, from week one to week eleven, the frond size of ten individuals from each species, as body size trait, in each environmental condition alongside their corresponding species density. We calculated the average trait change as $\Delta x$ = $\^{x}_{ijt} - \^{x}_{ijt-1}$, where $\^{x}_{ij}$ described the mean trait of species $i$ in environment $j$ and week $t$. As no $\Delta \hat{x}$ value could be calculated for week one of the experiments, it was omitted from the analysis.  
We fitted two HMSC models to the data: An 'evolution model' in which $\Delta \hat{x}$ of each species and environmental conditions were applied as explanatory variable, and a 'no-evolution model', in which only the environmental conditions were included. Species density was log-transformed species before applying it to the model, therefore we could use normal distribution in the model. Additionally, we applied replicates (*n* = 2) and time as random effects. For each model we ran four Markov chain Monte-Carlos' for 1,875,000 iterations from which the first 625,000 were cut off as the transient phase and with a thinning factor of 5,000 250 samples were taken from each chain.  
To test the impact of evolution by the model, we extracted the posterior distributions of the estimated beta effects. These were multiplied with the $\Delta \hat{x}$ of the corresponding species and summed up together with the intercept.

# Results

## Linear statistical models for one- and two-species models of growth, competition, and trait evolution

Linear regression models can estimate the impacts of intra- and interspecific competition, environmental variation, and trait evolution for population size in simple one- and two-species models of population growth. In simple cases (one-species models, linear and quadratic relationships between environment and population size), the regression coefficients successfully reflect the direction and magnitude of the relationships included in the non-linear simulation model (the impact of $N_t$ and $E_t$ for $N_{t+1}$). However, as the processes included in the simulation models become slightly more complex (competition with a second species, spatial structure), regression coefficients were useful for prediction but not for recreating the underlying processes driving changes in population size (Appendix S1; REF?).

To consider species interactions and environmental fluctuations (model *iv*; Figure 1a \@ref(fig:fig1)), we used the latent variable modelling approach implemented in HMSC. The linear model successfully estimated coefficients for fixed environmental effects that captured the impacts of environment for population size in both species (Figure 1b,c) and partitioned the relative importance of the environment and species interactions for species abundances (Figure 1d). The model coefficients could also predict the population size values over time (Figure 1a), though the quality of this prediction varied depending on the level of environmental noise (Appendix S1).

```{r, out.width="90%", include=TRUE, fig.align="center", fig.cap=c("your caption"), echo=FALSE}
knitr::include_graphics("../output/fig1.pdf")
```

The HMSC model was successfully modelled changes in species abundances when trait evolution was introduced (model *v*; Figure 1e \@ref(fig:fig1)). Fixed effect coefficients for the environmental driver and the total trait change from one time to the next (\|\Delta x\|) matched well with observed data (Figure 1f,g). The model estimated the relative importance of the environmental driver, trait evolution in both species, and species interactions (Figure 1h), and predicted the observed species abundances well (Figure 1e). Spatial structure was also reproduced in the coefficients of the linear HMSC model by using spatial random effects to capture covariance in species abundances as a function of spatial distance between sites in the 10-patch simulation model (model *vi*; Figure 1i,j,k \@ref(fig:fig1)). The variation partition successfully reflects separation of environmental drivers from trait evolution, species interactions, and spatial random effects (Figure 1l), and we show in Appendix S1 that the relative importance of trait evolution increases when we use a simulation model with less spatial and environmental variation and weak species interactions.

## Evolution in metacommunities and HMSC

The simulation model followed population size and trait value dynamics for species in the landscape across 200 time steps (Figure 4a \@ref(fig:fig4)). Resulting biodiversity dynamics depended on the dispersal level and heritability values (Figure 4b \@ref(fig:fig4)). For dispersal, results mirrored some expectations from existing metacommunity models, i.e. that regional $\gamma$ diversity decreases with increasing dispersal level ([@Mouquet2003]; Figure 4b \@ref(fig:fig4)). The inclusion of trait heritability had a very strong effect on community diversity, reflecting that local adaptation can rescue species and contribute to richness at the local and metacommunity scale. Species diversity at the regional $\gamma$ level increased with increasing $h^2$ levels (Figure 4b \@ref(fig:fig4)).

Analysis using the HMSC model for community time series across $d$ and $h^2$ levels indicated that the importance of evolution for community composition ($V_{|\Delta x|}$) decreased with increasing dispersal and with increasing heritability (Figure 4c,d,e \@ref(fig:fig4)). 

```{r, out.width="90%", include=TRUE, fig.align="center", fig.cap=c("your caption"), echo=FALSE}
knitr::include_graphics("../output/fig4.pdf")
```

### Empirical data

The empirical data [@Jewell2023] showed the community dynamics of four plant species under different environmental conditions, additionally the front size of each species was measured to determine its trait change over time. We calculated the mean variance partitioning (VP) over all species, to evaluate the impact of evolutionary (change of the front size trait) and ecological (light and nutrient treatments) effects on changes on species density. Almost one fifth (18.6%) of the variance in species density could be explained by the variance in $\Delta \hat{x}$ (\@ref(fig:fig5)a). This is due to the reduction of the VP of the ecological effects by a total of 14.4% (from 37% to 26.6% for the amount of shading and from 31% to 27.1% for the nutrient concentrations) and the reduction of 4.2% of the random effects (from 18.7% to 15% for time and from 13.3% to 12.8% for replicates) (\@ref(fig:fig5)). While $\Delta \hat{x}$ of the species Lm, Sp and Wc showed a similarly low impact, on average 3.6%, $\Delta \hat{x}$ of species Rn showed a high impact on variance of species density, 7.8%, which can be explained by its high $\Delta \hat{x}$ changes over time (see Appendix S05). The high density intervals (HDI) of 95% estimated beta effects showed a negative correlation of Light shading with species density, while nutrient concentration correlated positively with density (\@ref(fig:fig5)c). Changes in $\Delta \hat{x}$ impacted densities differently. At one hand changes of species Rn frond size correlated negatively with is density, on the other hand changes in the frond size of species Wc showed a positive correlation with the other species Sp and Lm (\@ref(fig:fig5)c). The impact of evolution (of all species summed up), impacted species density over time, yet did not show a clear direction over the course of the experiment (\@ref(fig:fig5)d).

```{r, out.width="90%", include=TRUE, fig.align="center", fig.cap=c("The estimated effects of species trait changes and environmental treatments. The variance partitioning of all fixed effects of the HMSC model (a) including trait changes with envrionmental treatments and (b) only including the environmental treamtents. The (b) high density interval of 95% showed a clear pattern for the different environmental treatments, yet differing results for trait changes and their impact on species density. This can be seen in (d) the shifting predictions of density over time due to the total trait changes of all species."), echo=FALSE}
knitr::include_graphics("../output/fig5.pdf")
```

# Discussion

### Empirical data

By implementing the trait changes of the four different species (Lm, Rn, Sp and Wc) in the HMSC model we were able to infer the relative impact of the trait changes on the community dynamics. This application shows is advantages over previous methods,which estimate the impact of trait changes (thus evolution), as it is not depended on the data structure and simplicity [@Hairston2005] [@Ellner2011], can be implemented on multiple species[@Lasky2020] and does not require additional common garden experiments [@Garzon2019]. Therefore this allows for a straight forward implementation of HMSC on a variety of data structures as lone as a clear response variable (e.g. species density) and ecological (e.g. environmental conditions) as well as evolutionary (e.g. heritable trait change) are measured. An additional advantage of HMSC, and JSDMs in general, is the ability to use the empirical data to predict a species response to changes in the environmental variables, even beyond the measured values [@Tikhonov2020] [@Ovaskainen2015]. With the implementation this approach can be combined with the fixed effects to answer further questions, such as: How does trait change impact the species density under changing environmental conditions? And how does the impact of trait changes depend on specific environmental conditions? 

At the same time a correct interpretation of such predictions as well es the estimated posterior beta distribution require a thorough understand of the experimental system. For example we often observed a negative correlation between trait change and species density in our simulations and also in species Rn of the empirical data, yet they derived from different mechanisms. In our simulations trait changes were greater when a species trait was further away from the optimal trait value, this greater distance resulted also in lower fitness and thus lower population size, while a species with higher fitness and thus higher population size had smaller trait changes. Therefore, HMSC correlates a high trait changes with a low population size and thus estimates a negative beta effect. Such effects can be expected in empirical data of i.e. evolutionary rescue experiments, where a species has to adapt to a deleterious environment before going extinct [@Gomulkiewicz1995][@Bell2009]. In the empirical data this negative correlation was the result of the species Rn investing into a larger frond size (Fig. SX), this likely lead to a lower investment into reproduction, while still maintaining a similar total frond area on the water surface to capture the reduced light. 

# References

::: {#refs}
:::

# <a name="appendix">Figures & Tables</a>
 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7